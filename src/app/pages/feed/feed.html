<div class="feed-wrapper">
  <!-- User Profile Header: This section displays the user's profile information, including their avatar, name, role, and community name. It also includes a logout button for the user to log out. -->
  <div class="user-header">
    <div class="user-profile">
      <div class="user-avatar">{{ userName.charAt(0).toUpperCase() }}</div>
      <div class="user-info">
        <h2 class="user-name">{{ userName || 'Guest' }}</h2>
        <p class="user-status">
          <span>{{ userRole || 'User' }}</span> ‚Ä¢ <span>{{ displayCommunityName }}</span>
        </p>
      </div>
      <button class="btn-back" (click)="goBack()">{{ 'LOGOUT' | translate }}</button>
    </div>
    <app-navbar></app-navbar>
  </div>

  <!-- Main Feed Content: This is the main content area of the feed page, containing the feed grid with posts and trends. -->
  <div class="feed-content">
    <div class="feed-grid">
      <!-- Center Column: Main Feed: This column contains the main feed, including the welcome card, create post card, feed stats, and the posts feed. -->
      <div class="feed-center-column">
        <!-- Welcome Card: This card welcomes the user to the community and can be removed by the user. -->
        <div class="welcome-card" *ngIf="showWelcomeCard">
          <div class="welcome-image">
            <div class="mountain-placeholder"></div>
            <div class="welcome-overlay">
              <button class="welcome-close-btn" (click)="removeWelcomeCard()" title="Remove welcome card">√ó</button>
              <h1 class="welcome-title">{{ 'WELCOME_HEADER' | translate }} {{ displayCommunityName }}</h1>
              <p class="welcome-subtitle">Share your thoughts and connect with the community</p>
            </div>
          </div>
        </div>

        <!-- Create Post Card: This card allows the user to create a new post, with tabs for text or image posts. -->
        <div class="create-post-card">
          <div class="create-post-header">
            <h2 class="section-title">{{ 'CREATE_POST' | translate }}</h2>
          </div>

          <!-- Post Tabs -->
          <div class="post-tabs">
            <button class="tab-btn" [class.active]="currentTab === 'post'" (click)="switchTabUI('post')">
              <span class="tab-icon">üìù</span>
              {{ 'TEXT_POST' | translate }}
            </button>
            <button class="tab-btn" [class.active]="currentTab === 'image'" (click)="switchTabUI('image')">
              <span class="tab-icon">üñºÔ∏è</span>
              {{ 'IMAGE_POST' | translate }}
            </button>
          </div>

          <!-- Image Selection (Visible for image tab) -->
          <div class="image-upload-section" *ngIf="currentTab === 'image'" style="padding: 15px;">
            <input type="file" #feedFileInput hidden accept="image/*" (change)="onFileSelected($event)" />
            <button type="button" class="upload-label" (click)="feedFileInput.click()"
              style="display: inline-block; padding: 10px 20px; background: rgba(255, 184, 77, 0.1); border: 1px dashed #ffb84d; border-radius: 8px; cursor: pointer; color: #ffb84d; width: 100%; text-align: center;">
              {{ imagePreview ? ('CHANGE_IMAGE' | translate) : ('SELECT_IMAGE_DEVICE' | translate) }}
            </button>
            <div class="preview-container" *ngIf="imagePreview"
              style="margin-top: 15px; border-radius: 8px; overflow: hidden; max-height: 200px;">
              <img [src]="imagePreview" alt="Upload preview" style="width: 100%; object-fit: cover;" />
            </div>
          </div>

          <!-- Post Input -->
          <div class="post-input-container">
            <textarea class="post-textarea"
              [placeholder]="currentTab === 'image' ? ('ADD_CAPTION' | translate) : ('WHATS_ON_YOUR_MIND' | translate)"
              rows="4" [(ngModel)]="postText"></textarea>
          </div>

          <!-- Post Button -->
          <button class="post-button" (click)="handlePostSubmit()"
            [disabled]="isUploading || (!postText.trim() && !imagePreview)">
            {{ isUploading ? ('UPLOADING' | translate) : (currentTab === 'post' ? ('POST' | translate) : ('UPLOAD_POST'
            | translate)) }}
          </button>
        </div>

        <!-- Feed Stats: This section shows statistics about the feed, such as number of posts, likes, and comments, visible only to admins. -->
        <div class="feed-stats" *ngIf="isAdmin">
          <div class="stats-info">
            <span>{{ getPostCount() }} {{ 'POSTS' | translate }}</span>
            <span>{{ getTotalLikes() }} {{ 'LIKES' | translate }}</span>
            <span>{{ getTotalComments() }} {{ 'COMMENTS' | translate }}</span>
          </div>
        </div>

        <!-- Posts Feed: This section displays all the posts in the feed, filtered by tag if selected. -->
        <div class="posts-feed">
          <!-- Filter Indicator: This indicator shows if the posts are filtered by a specific tag and allows clearing the filter. -->
          <div class="filter-indicator" *ngIf="currentTag"
            style="margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; background: rgba(138, 43, 226, 0.1); padding: 10px 20px; border-radius: 8px; border: 1px solid rgba(255, 184, 77, 0.2);">
            <span style="color: #ffb84d;">{{ 'FILTERING_BY' | translate }}: <strong>{{ currentTag }}</strong></span>
            <button (click)="onHashtagClick(currentTag)"
              style="background: none; border: none; color: white; cursor: pointer;">‚úï {{ 'CLEAR' | translate
              }}</button>
          </div>

          <!-- Empty State -->
          <div *ngIf="filteredPosts.length === 0" class="empty-state"
            style="text-align: center; padding: 40px 20px; background: rgba(138, 43, 226, 0.05); border: 1px dashed rgba(255, 184, 77, 0.3); border-radius: 12px; margin-bottom: 20px;">
            <div style="font-size: 48px; margin-bottom: 15px;">üìÇ</div>
            <h3 style="color: #ffb84d; margin-bottom: 10px;">{{ 'NO_POSTS_YET' | translate }}</h3>
            <p style="color: rgba(255, 255, 255, 0.7); margin-bottom: 20px;">{{ 'BE_THE_FIRST_TO_POST' | translate }}
            </p>

            <button *ngIf="userRole === 'admin'" (click)="seedCommunity()" class="post-button"
              style="max-width: 250px; margin: 0 auto; background: linear-gradient(135deg, #ffb84d, #ff6b35);">
              üå± {{ 'SEED_SAMPLE_POSTS' | translate }}
            </button>
          </div>

          <div class="post-card" *ngFor="let post of filteredPosts; trackBy: trackByPostId">
            <!-- Post Header: This part of the post shows the author's avatar, name, and time, with options for admins. -->
            <div class="post-header">
              <div class="post-avatar" (click)="navigateToProfile()">{{ post.avatar }}</div>
              <div class="post-meta" (click)="navigateToProfile()">
                <h3 class="post-author">
                  {{ post.author }}
                  <span class="pinned-badge" *ngIf="post.isPinned">üìå {{ 'PINNED' | translate }}</span>
                </h3>
                <p class="post-time">{{ post.createdAt.toDate() | date:'short' }}</p>
              </div>
              <div class="post-actions" *ngIf="userRole === 'admin'">
                <button class="pin-btn" (click)="pinPost(post)" [title]="post.isPinned ? 'Unpin post' : 'Pin post'">
                  {{ post.isPinned ? 'üìå' : 'üìç' }}
                </button>
                <button class="post-options" (click)="deletePost(post)">√ó</button>
              </div>
            </div>

            <!-- Post Content: This displays the text content of the post. -->
            <p class="post-content">{{ post.content }}</p>

            <!-- Image Post Content: This displays the image for image posts. -->
            <div class="post-image" *ngIf="post.type === 'image' && post.imageData">
              <img [src]="post.imageData" alt="Post image" />
            </div>

            <!-- Post Tags: This shows the tags associated with the post, clickable to filter. -->
            <div class="post-tags">
              <span class="post-tag" *ngFor="let tag of post.tags" (click)="onHashtagClick(tag)">
                {{ tag }}
              </span>
            </div>

            <!-- Post Footer: This shows the like and comment buttons with counts. -->
            <div class="post-footer">
              <button class="post-action" (click)="onLikePost(post)">
                <span class="action-icon">{{ post.likedBy.includes(userName) ? '‚ù§Ô∏è' : 'ü§ç' }}</span>
                <span class="action-count">{{ post.likes }}</span>
              </button>
              <button class="post-action" (click)="onCommentPost(post)">
                <span class="action-icon">üí¨</span>
                <span class="action-count">{{ post.comments.length }}</span>
              </button>
            </div>

            <!-- Comments Section: This section displays the comments on the post, with replies. -->
            <div class="comments-section" *ngIf="post.comments.length > 0">
              <ng-container
                *ngTemplateOutlet="commentTemplate; context: { comments: post.comments, postId: post.id, level: 0 }"></ng-container>
            </div>

            <ng-template #commentTemplate let-comments="comments" let-postId="postId" let-level="level">
              <div class="comment" *ngFor="let comment of comments" [style.margin-left.px]="level * 20">
                <div class="comment-header">
                  <strong>{{ comment.username }}</strong>
                  <span class="comment-time" *ngIf="comment.time && comment.time.toDate">{{ comment.time.toDate() |
                    date:'short' }}</span>
                </div>
                <p class="comment-text">{{ comment.text }}</p>
                <button class="reply-btn" (click)="toggleReplyInput(comment.id)"
                  style="background:none; border:none; color: #ffb84d; font-size:12px; cursor:pointer; margin-top:5px;">reply</button>
                <div class="reply-input" *ngIf="showReplyInput[comment.id]" style="margin-top:10px;">
                  <textarea class="comment-input" placeholder="{{ 'WRITE_REPLY' | translate }}"
                    [(ngModel)]="newReplyText[comment.id]" rows="2"></textarea>
                  <button class="comment-submit-btn" (click)="submitReply(comment, postId)"
                    [disabled]="!newReplyText[comment.id]?.trim()"
                    style="margin-top:5px; padding: 5px 15px; font-size: 12px;">
                    {{ 'SEND' | translate }}
                  </button>
                </div>
                <!-- Replies -->
                <ng-container
                  *ngIf="comment.replies && comment.replies.length > 0; then repliesTemplate"></ng-container>
                <ng-template #repliesTemplate>
                  <ng-container
                    *ngTemplateOutlet="commentTemplate; context: { comments: comment.replies, postId: postId, level: level + 1 }"></ng-container>
                </ng-template>
              </div>
            </ng-template>

            <!-- Add Comment: This allows users to add a new comment to the post. -->
            <div class="add-comment">
              <textarea class="comment-input" placeholder="{{ 'WRITE_COMMENT' | translate }}"
                [(ngModel)]="newCommentText[post.id]" rows="2"></textarea>
              <button class="comment-submit-btn" (click)="submitComment(post)"
                [disabled]="!newCommentText[post.id]?.trim()">
                {{ 'SEND' | translate }}
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column: Trends: This column shows trending tags, popular posts, and active members. -->
      <div class="trends-column">
        <!-- Trending Tags: This section shows popular hashtags that users can click to filter posts. -->
        <div class="trending-section right-column-box">
          <h3 class="section-title">{{ 'TRENDING' | translate }}</h3>
          <div class="hashtags-container">
            <button class="hashtag-btn" *ngFor="let tag of trendingTags" (click)="onHashtagClick(tag)">
              {{ tag }}
            </button>
          </div>
        </div>

        <!-- Popular Posts: This section shows the most popular posts based on likes and comments. -->
        <div class="popular-posts right-column-box">
          <h3 class="section-title">{{ 'POPULAR_POSTS' | translate }}</h3>
          <div class="popular-post" *ngFor="let post of popularPosts"
            style="margin-bottom: 10px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px;">
            <p class="popular-post-content">{{ post.content.substring(0, 100) }}...</p>
            <p class="popular-post-likes">‚ù§Ô∏è {{ post.likes }} {{ 'LIKES' | translate }} ‚Ä¢ üí¨ {{ post.comments.length }}
              {{ 'COMMENTS' | translate }}</p>
          </div>
        </div>

        <!-- Active Members: This section shows the most active members based on post count. -->
        <div class="active-members right-column-box">
          <h3 class="section-title">{{ 'ACTIVE_MEMBERS' | translate }}</h3>
          <div class="active-member" *ngFor="let member of activeMembers"
            style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
            <div class="member-avatar">{{ member.avatar }}</div>
            <div class="member-info">
              <h4 class="member-name">{{ member.name }}</h4>
              <p class="member-activity">{{ member.activity }} {{ 'POSTS' | translate }}</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>